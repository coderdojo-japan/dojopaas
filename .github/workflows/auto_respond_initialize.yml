name: ã‚µãƒ¼ãƒãƒ¼åˆæœŸåŒ–ä¾é ¼ã¸ã®è‡ªå‹•å¿œç­”

on:
  issues:
    types: [opened]

jobs:
  check_and_respond:
    # Issue ã‚¿ã‚¤ãƒˆãƒ«ã«ã€ŒåˆæœŸåŒ–ä¾é ¼ã€ãŒå«ã¾ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿å®Ÿè¡Œ
    if: contains(github.event.issue.title, 'åˆæœŸåŒ–ä¾é ¼')
    runs-on: ubuntu-latest
    
    permissions:
      issues: write
      contents: read
    
    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v3
      
      - name: Rubyç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: ruby/setup-ruby@v1
        with:
          bundler-cache: true
      
      - name: Issueæœ¬æ–‡ã‹ã‚‰IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æŠ½å‡º
        id: extract_ip
        run: |
          # Issueæœ¬æ–‡ã‚’æŠ½å‡º
          ISSUE_BODY="${{ github.event.issue.body }}"
          
          # IPã‚¢ãƒ‰ãƒ¬ã‚¹ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æŠ½å‡ºï¼ˆæ•°å­—ã¨ãƒ‰ãƒƒãƒˆã®ã¿ï¼‰
          IP_ADDRESS=$(echo "$ISSUE_BODY" | grep -oE '\b([0-9]{1,3}\.){3}[0-9]{1,3}\b' | head -1)
          
          if [ -z "$IP_ADDRESS" ]; then
            echo "âŒ Issueæœ¬æ–‡ã«IPã‚¢ãƒ‰ãƒ¬ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ"
            echo "ip_found=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "ğŸ“ IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ç™ºè¦‹: $IP_ADDRESS"
          echo "ip_address=$IP_ADDRESS" >> $GITHUB_OUTPUT
          echo "ip_found=true"          >> $GITHUB_OUTPUT
      
      - name: IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æ¤œè¨¼ã—ã¦ã‚µãƒ¼ãƒãƒ¼æƒ…å ±ã‚’æ¤œç´¢
        if: steps.extract_ip.outputs.ip_found == 'true'
        id: find_server
        env:
          SACLOUD_ACCESS_TOKEN:        ${{ secrets.SACLOUD_ACCESS_TOKEN }}
          SACLOUD_ACCESS_TOKEN_SECRET: ${{ secrets.SACLOUD_ACCESS_TOKEN_SECRET }}
          IP_ADDRESS:                  ${{ steps.extract_ip.outputs.ip_address }}
          CI: true
        run: |
          # IPæ¤œè¨¼ä»˜ãã®Rakeã‚¿ã‚¹ã‚¯ã‚’ä½¿ç”¨
          OUTPUT=$(bundle exec rake server:find_for_initialization 2>&1) || EXIT_CODE=$?
          
          # GitHub Actionsç”¨ã«å‡ºåŠ›ã‚’ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
          OUTPUT="${OUTPUT//'%'/'%25'}"
          OUTPUT="${OUTPUT//$'\n'/'%0A'}"
          OUTPUT="${OUTPUT//$'\r'/'%0D'}"
          
          if [ -z "$EXIT_CODE" ] || [ "$EXIT_CODE" = "0" ]; then
            echo "server_found=true" >> $GITHUB_OUTPUT
            echo "server_info<<EOF" >> $GITHUB_OUTPUT
            echo "$OUTPUT" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "server_found=false" >> $GITHUB_OUTPUT
            echo "error_message<<EOF" >> $GITHUB_OUTPUT
            echo "$OUTPUT" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi
      
      - name: Issueã«ã‚³ãƒ¡ãƒ³ãƒˆ - ã‚µãƒ¼ãƒãƒ¼ãŒè¦‹ã¤ã‹ã£ãŸå ´åˆ
        if: |
          steps.extract_ip.outputs.ip_found      == 'true' &&
          steps.find_server.outputs.server_found == 'true'
        uses: actions/github-script@v6
        with:
          script: |
            const serverInfo = `${{ steps.find_server.outputs.server_info }}`.replace(/%0A/g, '\n').replace(/%0D/g, '\r').replace(/%25/g, '%');
            
            const comment = `## ğŸ” ã‚µãƒ¼ãƒãƒ¼æƒ…å ±ã‚’ç¢ºèªã—ã¾ã—ãŸ
            
            ${serverInfo}
            
            ---
            
            ### ğŸ“‹ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—
            
            @yasulab ã“ã®ã‚µãƒ¼ãƒãƒ¼ã‚’åˆæœŸåŒ–ã™ã‚‹å ´åˆã¯ã€ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ï¼š
            
            \`\`\`bash
            # 1. ã‚µãƒ¼ãƒãƒ¼ã‚’å‰Šé™¤
            ruby scripts/initialize_server.rb --delete ${{ steps.extract_ip.outputs.ip_address }} --force
            
            # 2. ç©ºã‚³ãƒŸãƒƒãƒˆã§CI/CDã‚’å®Ÿè¡Œï¼ˆæ–°ã‚µãƒ¼ãƒãƒ¼ä½œæˆï¼‰
            git commit --allow-empty -m "Fix #${{ github.event.issue.number }}: Initialize server for ${{ github.event.issue.user.login }}"
            git push
            \`\`\`
            
            âš ï¸ **æ³¨æ„**: ã‚µãƒ¼ãƒãƒ¼å‰Šé™¤ã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚å‰Šé™¤å‰ã«å¿…ãšç¢ºèªã—ã¦ãã ã•ã„ã€‚
            `;
            
            await github.rest.issues.createComment({
              owner:        context.repo.owner,
              repo:         context.repo.repo,
              issue_number: context.issue.number,
              body:         comment
            });
      
      - name: Issueã«ã‚³ãƒ¡ãƒ³ãƒˆ - ã‚µãƒ¼ãƒãƒ¼ãŒè¦‹ã¤ã‹ã‚‰ãªã‹ã£ãŸå ´åˆ
        if: |
          steps.extract_ip.outputs.ip_found      == 'true' &&
          steps.find_server.outputs.server_found == 'false'
        uses: actions/github-script@v6
        with:
          script: |
            const errorMessage = `${{ steps.find_server.outputs.error_message }}`.replace(/%0A/g, '\n').replace(/%0D/g, '\r').replace(/%25/g, '%');
            
            const comment = `## âŒ ã‚µãƒ¼ãƒãƒ¼æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ
            
            IPã‚¢ãƒ‰ãƒ¬ã‚¹: \`${{ steps.extract_ip.outputs.ip_address }}\`
            
            ### ã‚¨ãƒ©ãƒ¼è©³ç´°
            \`\`\`
            ${errorMessage}
            \`\`\`
            
            @yasulab æ‰‹å‹•ã§ã®ç¢ºèªãŒå¿…è¦ã§ã™ã€‚
            
            ### ç¢ºèªã‚³ãƒãƒ³ãƒ‰
            \`\`\`bash
            ruby scripts/initialize_server.rb --find ${{ steps.extract_ip.outputs.ip_address }}
            \`\`\`
            `;
            
            await github.rest.issues.createComment({
              owner:        context.repo.owner,
              repo:         context.repo.repo,
              issue_number: context.issue.number,
              body:         comment
            });
      
      - name: Issueã«ã‚³ãƒ¡ãƒ³ãƒˆ - IPã‚¢ãƒ‰ãƒ¬ã‚¹ãŒè¦‹ã¤ã‹ã‚‰ãªã‹ã£ãŸå ´åˆ
        if: steps.extract_ip.outputs.ip_found == 'false'
        uses: actions/github-script@v6
        with:
          script: |
            const comment = `## âš ï¸ IPã‚¢ãƒ‰ãƒ¬ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ
            
            Issueã®æœ¬æ–‡ã‹ã‚‰IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æŠ½å‡ºã§ãã¾ã›ã‚“ã§ã—ãŸã€‚
            
            ### æ­£ã—ã„ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆä¾‹
            \`\`\`
            CoderDojoã€é“å ´åã€‘ã®ã€ç”³è«‹è€…åã€‘ã§ã™ã€‚
            ã‚µãƒ¼ãƒãƒ¼ï¼ˆIPã‚¢ãƒ‰ãƒ¬ã‚¹ï¼š192.168.1.1ï¼‰ã®åˆæœŸåŒ–ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚
            \`\`\`
            
            @yasulab æ‰‹å‹•ã§ã®ç¢ºèªã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚
            `;
            
            await github.rest.issues.createComment({
              owner:        context.repo.owner,
              repo:         context.repo.repo,
              issue_number: context.issue.number,
              body:         comment
            });
