name: ã‚µãƒ¼ãƒãƒ¼åˆæœŸåŒ–ä¾é ¼ã¸ã®è‡ªå‹•å¿œç­”
# Rakeã®ä¾å­˜é–¢ä¿‚ç®¡ç†ã‚’æ´»ç”¨ã—ãŸæ”¹å–„ç‰ˆ

on:
  issues:
    types: [opened]

jobs:
  check_and_respond:
    # Issue ã‚¿ã‚¤ãƒˆãƒ«ã«ã€ŒåˆæœŸåŒ–ä¾é ¼ã€ãŒå«ã¾ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿å®Ÿè¡Œ
    if: contains(github.event.issue.title, 'åˆæœŸåŒ–ä¾é ¼')
    runs-on: ubuntu-latest
    
    permissions:
      issues: write
      contents: read
    
    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
      
      - name: Rubyç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: ruby/setup-ruby@v1
        with:
          bundler-cache: true
      
      - name: Issueæœ¬æ–‡ã‹ã‚‰IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æŠ½å‡º
        id: extract_ip
        run: |
          # Issueæœ¬æ–‡ã‚’æŠ½å‡º
          ISSUE_BODY="${{ github.event.issue.body }}"
          
          # IPã‚¢ãƒ‰ãƒ¬ã‚¹ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æŠ½å‡ºï¼ˆæ•°å­—ã¨ãƒ‰ãƒƒãƒˆã®ã¿ï¼‰
          IP_ADDRESS=$(echo "$ISSUE_BODY" | grep -oE '\b([0-9]{1,3}\.){3}[0-9]{1,3}\b' | head -1)
          
          if [ -z "$IP_ADDRESS" ]; then
            echo "âŒ Issueæœ¬æ–‡ã«IPã‚¢ãƒ‰ãƒ¬ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ"
            echo "ip_found=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "ğŸ“ IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ç™ºè¦‹: $IP_ADDRESS"
          echo "ip_address=$IP_ADDRESS" >> $GITHUB_OUTPUT
          echo "ip_found=true"          >> $GITHUB_OUTPUT
      
      - name: IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æ¤œè¨¼ã—ã¦ã‚µãƒ¼ãƒãƒ¼æƒ…å ±ã‚’æ¤œç´¢
        if: steps.extract_ip.outputs.ip_found == 'true'
        id: find_server
        env:
          SACLOUD_ACCESS_TOKEN:        ${{ secrets.SACLOUD_ACCESS_TOKEN }}
          SACLOUD_ACCESS_TOKEN_SECRET: ${{ secrets.SACLOUD_ACCESS_TOKEN_SECRET }}
          CI: true
        run: |
          # çµ±ä¸€å‘½åãƒ‘ã‚¿ãƒ¼ãƒ³ã«å¾“ã£ãŸfind_by_ipã‚¿ã‚¹ã‚¯ã‚’ä½¿ç”¨
          # IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æ˜ç¤ºçš„ã«ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¨ã—ã¦æ¸¡ã™ï¼ˆENVçµŒç”±ã§ã¯ãªãï¼‰
          # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£: ãƒˆãƒ¼ã‚¯ãƒ³æƒ…å ±ã‚’ãƒã‚¹ã‚­ãƒ³ã‚°
          OUTPUT=$(bundle exec rake "server:find_by_ip[${{ steps.extract_ip.outputs.ip_address }}]" 2>&1 | \
            sed 's/SACLOUD_ACCESS_TOKEN=.*/SACLOUD_ACCESS_TOKEN=***/' | \
            sed 's/SACLOUD_ACCESS_TOKEN_SECRET=.*/SACLOUD_ACCESS_TOKEN_SECRET=***/' ) || EXIT_CODE=$?
          
          # GitHub Actionsç”¨ã«å‡ºåŠ›ã‚’ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
          OUTPUT="${OUTPUT//'%'/'%25'}"
          OUTPUT="${OUTPUT//$'\n'/'%0A'}"
          OUTPUT="${OUTPUT//$'\r'/'%0D'}"
          
          if [ -z "$EXIT_CODE" ] || [ "$EXIT_CODE" = "0" ]; then
            echo "server_found=true" >> $GITHUB_OUTPUT
            echo "server_info<<EOF"  >> $GITHUB_OUTPUT
            echo "$OUTPUT"           >> $GITHUB_OUTPUT
            echo "EOF"               >> $GITHUB_OUTPUT
            
            # å‰Šé™¤æº–å‚™ã‚¿ã‚¹ã‚¯ã‚‚å®Ÿè¡Œï¼ˆã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ã‚¿ãƒ«å®Ÿè¡Œç”¨ï¼‰
            # IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æ˜ç¤ºçš„ã«ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¨ã—ã¦æ¸¡ã™
            bundle exec rake "server:prepare_deletion[${{ steps.extract_ip.outputs.ip_address }}]" 2>&1 || true
          else
            echo "server_found=false" >> $GITHUB_OUTPUT
            echo "error_message<<EOF" >> $GITHUB_OUTPUT
            echo "$OUTPUT"            >> $GITHUB_OUTPUT
            echo "EOF"                >> $GITHUB_OUTPUT
          fi
      
      - name: Issueã«ã‚³ãƒ¡ãƒ³ãƒˆ - ã‚µãƒ¼ãƒãƒ¼ãŒè¦‹ã¤ã‹ã£ãŸå ´åˆ
        if: |
          steps.extract_ip.outputs.ip_found      == 'true' &&
          steps.find_server.outputs.server_found == 'true'
        uses: actions/github-script@v6
        with:
          script: |
            // ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°: ã‚³ãƒ¡ãƒ³ãƒˆä½œæˆã‚’DRYåŒ–
            const createIssueComment = (comment) => {
              return github.rest.issues.createComment({
                owner:        context.repo.owner,
                repo:         context.repo.repo,
                issue_number: context.issue.number,
                body:         comment
              });
            };
            
            const serverInfo = `${{ steps.find_server.outputs.server_info }}`.replace(/%0A/g, '\n').replace(/%0D/g, '\r').replace(/%25/g, '%');
            
            const comment = `## ğŸ” ã‚µãƒ¼ãƒãƒ¼æƒ…å ±ã‚’ç¢ºèªã—ã¾ã—ãŸ

            \`\`\`
            ${serverInfo}
            \`\`\`
            
            ---
            
            ### ğŸ“‹ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—
            
            @yasulab ã“ã®ã‚µãƒ¼ãƒãƒ¼ã‚’åˆæœŸåŒ–ã™ã‚‹å ´åˆã¯ã€ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ï¼š
            
            #### Rakeã‚¿ã‚¹ã‚¯ã‚’ä½¿ç”¨ã—ãŸå®Œå…¨ãªãƒ•ãƒ­ãƒ¼ï¼ˆæ¨å¥¨ï¼‰
            \`\`\`bash
            # å…¨ã‚¹ãƒ†ãƒƒãƒ—ã‚’è‡ªå‹•å®Ÿè¡Œï¼ˆä¾å­˜é–¢ä¿‚ç®¡ç†ä»˜ãï¼‰
            bundle exec rake "server:initialize[${{ steps.extract_ip.outputs.ip_address }},${{ github.event.issue.number }}]"
            git push
            \`\`\`
            
            #### ã¾ãŸã¯å€‹åˆ¥ã‚¹ãƒ†ãƒƒãƒ—å®Ÿè¡Œ
            \`\`\`bash
            # 1. å‰Šé™¤æº–å‚™ï¼ˆæƒ…å ±ç¢ºèªï¼‰
            bundle exec rake "server:prepare_deletion[${{ steps.extract_ip.outputs.ip_address }}]"
            
            # 2. ã‚µãƒ¼ãƒãƒ¼å‰Šé™¤
            bundle exec rake "server:execute_deletion[${{ steps.extract_ip.outputs.ip_address }},true]"
            
            # 3. ç©ºã‚³ãƒŸãƒƒãƒˆä½œæˆ
            bundle exec rake "server:create_empty_commit[${{ github.event.issue.number }}]"
            
            # 4. ãƒ—ãƒƒã‚·ãƒ¥ã§CI/CDå®Ÿè¡Œ
            git push
            \`\`\`
            
            âš ï¸ **æ³¨æ„**: ã‚µãƒ¼ãƒãƒ¼å‰Šé™¤ã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚å‰Šé™¤å‰ã«å¿…ãšç¢ºèªã—ã¦ãã ã•ã„ã€‚
            `;
            
            await createIssueComment(comment);
      
      - name: Issueã«ã‚³ãƒ¡ãƒ³ãƒˆ - ã‚µãƒ¼ãƒãƒ¼ãŒè¦‹ã¤ã‹ã‚‰ãªã‹ã£ãŸå ´åˆ
        if: |
          steps.extract_ip.outputs.ip_found      == 'true' &&
          steps.find_server.outputs.server_found == 'false'
        uses: actions/github-script@v6
        with:
          script: |
            // ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°: ã‚³ãƒ¡ãƒ³ãƒˆä½œæˆã‚’DRYåŒ–
            const createIssueComment = (comment) => {
              return github.rest.issues.createComment({
                owner:        context.repo.owner,
                repo:         context.repo.repo,
                issue_number: context.issue.number,
                body:         comment
              });
            };
            
            const errorMessage = `${{ steps.find_server.outputs.error_message }}`.replace(/%0A/g, '\n').replace(/%0D/g, '\r').replace(/%25/g, '%');
            
            const comment = `## âŒ ã‚µãƒ¼ãƒãƒ¼æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ
            
            IPã‚¢ãƒ‰ãƒ¬ã‚¹: \`${{ steps.extract_ip.outputs.ip_address }}\`
            
            ### ã‚¨ãƒ©ãƒ¼è©³ç´°
            \`\`\`
            ${errorMessage}
            \`\`\`
            
            @yasulab æ‰‹å‹•ã§ã®ç¢ºèªãŒå¿…è¦ã§ã™ã€‚
            
            ### ç¢ºèªã‚³ãƒãƒ³ãƒ‰
            \`\`\`bash
            # Rakeã‚¿ã‚¹ã‚¯ã‚’ä½¿ç”¨ï¼ˆçµ±ä¸€å‘½åãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰
            bundle exec rake "server:find_by_ip[${{ steps.extract_ip.outputs.ip_address }}]"
            
            # ã¾ãŸã¯ç›´æ¥ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œ
            ruby scripts/initialize_server.rb --find ${{ steps.extract_ip.outputs.ip_address }}
            \`\`\`
            `;
            
            await createIssueComment(comment);
      
      - name: Issueã«ã‚³ãƒ¡ãƒ³ãƒˆ - IPã‚¢ãƒ‰ãƒ¬ã‚¹ãŒè¦‹ã¤ã‹ã‚‰ãªã‹ã£ãŸå ´åˆ
        if: steps.extract_ip.outputs.ip_found == 'false'
        uses: actions/github-script@v6
        with:
          script: |
            // ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°: ã‚³ãƒ¡ãƒ³ãƒˆä½œæˆã‚’DRYåŒ–
            const createIssueComment = (comment) => {
              return github.rest.issues.createComment({
                owner:        context.repo.owner,
                repo:         context.repo.repo,
                issue_number: context.issue.number,
                body:         comment
              });
            };
            
            const comment = `## âš ï¸ IPã‚¢ãƒ‰ãƒ¬ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ
            
            Issueã®æœ¬æ–‡ã‹ã‚‰IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æŠ½å‡ºã§ãã¾ã›ã‚“ã§ã—ãŸã€‚
            
            ### æ­£ã—ã„ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆä¾‹
            \`\`\`
            CoderDojoã€é“å ´åã€‘ã®ã€ç”³è«‹è€…åã€‘ã§ã™ã€‚
            ã‚µãƒ¼ãƒãƒ¼ï¼ˆIPã‚¢ãƒ‰ãƒ¬ã‚¹ï¼š192.168.1.1ï¼‰ã®åˆæœŸåŒ–ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚
            \`\`\`
            
            @yasulab æ‰‹å‹•ã§ã®ç¢ºèªã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚
            `;
            
            await createIssueComment(comment);
